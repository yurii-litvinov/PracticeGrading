CREATE TABLE "Criteria" (
                            "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                            "Name" text NOT NULL,
                            "Comment" text,
                            CONSTRAINT "PK_Criteria" PRIMARY KEY ("Id")
);


CREATE TABLE "Meetings" (
                            "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                            "DateAndTime" timestamp with time zone NOT NULL,
                            "Auditorium" text,
                            "Info" text,
                            "CallLink" text,
                            "MaterialsLink" text,
                            CONSTRAINT "PK_Meetings" PRIMARY KEY ("Id")
);


CREATE TABLE "Role" (
                        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                        "RoleName" text NOT NULL,
                        CONSTRAINT "PK_Role" PRIMARY KEY ("Id")
);


CREATE TABLE "Rule" (
                        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                        "Type" text,
                        "Description" text NOT NULL,
                        "Value" integer NOT NULL,
                        "IsScaleRule" boolean NOT NULL,
                        "CriteriaId" integer NOT NULL,
                        CONSTRAINT "PK_Rule" PRIMARY KEY ("Id"),
                        CONSTRAINT "FK_Rule_Criteria_CriteriaId" FOREIGN KEY ("CriteriaId") REFERENCES "Criteria" ("Id") ON DELETE CASCADE
);


CREATE TABLE "CriteriaMeeting" (
                                   "CriteriaId" integer NOT NULL,
                                   "MeetingsId" integer NOT NULL,
                                   CONSTRAINT "PK_CriteriaMeeting" PRIMARY KEY ("CriteriaId", "MeetingsId"),
                                   CONSTRAINT "FK_CriteriaMeeting_Criteria_CriteriaId" FOREIGN KEY ("CriteriaId") REFERENCES "Criteria" ("Id") ON DELETE CASCADE,
                                   CONSTRAINT "FK_CriteriaMeeting_Meetings_MeetingsId" FOREIGN KEY ("MeetingsId") REFERENCES "Meetings" ("Id") ON DELETE CASCADE
);


CREATE TABLE "StudentWork" (
                               "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                               "StudentName" text NOT NULL,
                               "Info" text,
                               "Theme" text NOT NULL,
                               "Supervisor" text NOT NULL,
                               "Consultant" text,
                               "Reviewer" text,
                               "SupervisorMark" text,
                               "ReviewerMark" text,
                               "FinalMark" text NOT NULL,
                               "CodeLink" text,
                               "MeetingId" integer NOT NULL,
                               CONSTRAINT "PK_StudentWork" PRIMARY KEY ("Id"),
                               CONSTRAINT "FK_StudentWork_Meetings_MeetingId" FOREIGN KEY ("MeetingId") REFERENCES "Meetings" ("Id") ON DELETE CASCADE
);


CREATE TABLE "Users" (
                         "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                         "UserName" text NOT NULL,
                         "PasswordHash" text,
                         "RoleId" integer NOT NULL,
                         "MeetingId" integer,
                         CONSTRAINT "PK_Users" PRIMARY KEY ("Id"),
                         CONSTRAINT "FK_Users_Meetings_MeetingId" FOREIGN KEY ("MeetingId") REFERENCES "Meetings" ("Id") ON DELETE CASCADE,
                         CONSTRAINT "FK_Users_Role_RoleId" FOREIGN KEY ("RoleId") REFERENCES "Role" ("Id") ON DELETE CASCADE
);


CREATE TABLE "AverageCriteriaMark" (
                                       "CriteriaId" integer NOT NULL,
                                       "StudentWorkId" integer NOT NULL,
                                       "AverageMark" double precision,
                                       CONSTRAINT "PK_AverageCriteriaMark" PRIMARY KEY ("CriteriaId", "StudentWorkId"),
                                       CONSTRAINT "FK_AverageCriteriaMark_Criteria_CriteriaId" FOREIGN KEY ("CriteriaId") REFERENCES "Criteria" ("Id") ON DELETE CASCADE,
                                       CONSTRAINT "FK_AverageCriteriaMark_StudentWork_StudentWorkId" FOREIGN KEY ("StudentWorkId") REFERENCES "StudentWork" ("Id") ON DELETE CASCADE
);


CREATE TABLE "MemberMarks" (
                               "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                               "MemberId" integer NOT NULL,
                               "StudentWorkId" integer NOT NULL,
                               "Mark" integer NOT NULL,
                               "Comment" text,
                               CONSTRAINT "PK_MemberMarks" PRIMARY KEY ("Id"),
                               CONSTRAINT "FK_MemberMarks_StudentWork_StudentWorkId" FOREIGN KEY ("StudentWorkId") REFERENCES "StudentWork" ("Id") ON DELETE CASCADE,
                               CONSTRAINT "FK_MemberMarks_Users_MemberId" FOREIGN KEY ("MemberId") REFERENCES "Users" ("Id") ON DELETE CASCADE
);


CREATE TABLE "CriteriaMark" (
                                "Id" integer GENERATED BY DEFAULT AS IDENTITY,
                                "CriteriaId" integer NOT NULL,
                                "MemberMarkId" integer NOT NULL,
                                "Comment" text,
                                "Mark" integer,
                                CONSTRAINT "PK_CriteriaMark" PRIMARY KEY ("Id"),
                                CONSTRAINT "FK_CriteriaMark_Criteria_CriteriaId" FOREIGN KEY ("CriteriaId") REFERENCES "Criteria" ("Id") ON DELETE CASCADE,
                                CONSTRAINT "FK_CriteriaMark_MemberMarks_MemberMarkId" FOREIGN KEY ("MemberMarkId") REFERENCES "MemberMarks" ("Id") ON DELETE CASCADE
);


CREATE TABLE "SelectedRule" (
                                "RuleId" integer NOT NULL,
                                "CriteriaMarkId" integer NOT NULL,
                                "Value" integer NOT NULL,
                                CONSTRAINT "PK_SelectedRule" PRIMARY KEY ("RuleId", "CriteriaMarkId"),
                                CONSTRAINT "FK_SelectedRule_CriteriaMark_CriteriaMarkId" FOREIGN KEY ("CriteriaMarkId") REFERENCES "CriteriaMark" ("Id") ON DELETE CASCADE
);


INSERT INTO "Criteria" ("Id", "Comment", "Name")
VALUES (1, NULL, 'Ясность изложения цели работы, актуальность');
INSERT INTO "Criteria" ("Id", "Comment", "Name")
VALUES (2, 'Тут и далее имеется в виду ''как их донёс защищающийся''', 'Сложность работы');
INSERT INTO "Criteria" ("Id", "Comment", "Name")
VALUES (3, NULL, 'Полнота и целостность работы');
INSERT INTO "Criteria" ("Id", "Comment", "Name")
VALUES (4, NULL, 'Представление');
INSERT INTO "Criteria" ("Id", "Comment", "Name")
VALUES (5, 'для теоретических работ и работ с закрытым кодом не оценивается', 'Код');


INSERT INTO "Role" ("Id", "RoleName")
VALUES (1, 'admin');
INSERT INTO "Role" ("Id", "RoleName")
VALUES (2, 'member');


INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (1, 1, 'понятное коммерческое или научное применение', TRUE, NULL, 5);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (2, 1, 'достаточно понятна сфера применения, но нет указания на конкретных заинтересованных в работе или есть сомнения в полезности', TRUE, NULL, 4);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (3, 1, 'сфера полезности размыта, есть сомнения в актуальности, проект чисто для получения опыта', TRUE, NULL, 3);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (4, 1, '«мы в восторге от Вашей изобретательности, но поражены Вашей неосведомлённостью»', TRUE, NULL, 2);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (5, 1, 'делалось что-то, что уже и так все умеют, не имеет смысла даже с образовательной точки зрения', TRUE, NULL, 1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (6, 1, 'вообще не нужно', TRUE, NULL, 0);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (7, 1, 'за отсутствие указания достаточно узкой группы людей, кому нужна работа (для инженерных работ — конкретной компании/организации/коллектива)', FALSE, 'fixed', -1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (8, 2, 'с нуля за полгода не воспроизвести, требует глубокого погружения и серьёзных усилий', TRUE, NULL, 5);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (9, 2, 'честная работа за семестр, не требуется предварительных специальных знаний, однако требуются значимые усилия', TRUE, NULL, 4);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (10, 2, 'в целом несложно, кажется, что средним студентом делается за месяц, или за неделю членом комиссии', TRUE, NULL, 3);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (11, 2, 'делается что-то понятное и довольно простое, но пришлось почитать, поразбираться, решать проблемы', TRUE, NULL, 2);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (12, 2, 'по ощущениям, делается средним второкурсником часов за 10', TRUE, NULL, 1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (13, 2, 'уровень домашней работы первого курса или сделано просто по учебнику', TRUE, NULL, 0);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (14, 2, 'за демонстрацию недостаточного погружения в предметную область', FALSE, 'range', -3);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (15, 3, 'по умолчанию', TRUE, NULL, 5);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (16, 3, 'за отсутствие внятных выводов из обзора', FALSE, 'fixed', -1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (17, 3, 'за плохо оформленный текст отчёта', FALSE, 'range', -3);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (18, 3, 'за отсутствие или некачественный обзор', FALSE, 'range', -4);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (19, 3, 'за отсутствие экспериментов (плана экспериментов) или апробации результата (для теоретических работ не применяется)', FALSE, 'range', -4);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (20, 3, 'за слабое позиционирование результатов автора относительно уже существовавших или полученных другими членами команды', FALSE, 'range', -4);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (21, 4, 'слайды идеальны, выступление хорошо подготовлено, ответы на вопросы чёткие и по делу', TRUE, NULL, 5);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (22, 4, 'за каждую минуту сверх 7 минут на выступление', FALSE, 'custom', -1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (23, 4, 'за значимое количество опечаток на слайдах', FALSE, 'fixed', -1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (24, 4, 'за ошибки в представлении результатов экспериментов', FALSE, 'fixed', -1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (25, 4, 'за каждое нарушение пунктов из чеклиста по оформлению презентаций: https://docs.google.com/spreadsheets/d/1LvHveX6TdbzexuACcqGPeHIEph6cm4Hd0arCRQBqODw', FALSE, 'custom', -1);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (26, 4, 'за недостаточно подробное изложение', FALSE, 'range', -5);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (27, 5, 'по умолчанию', TRUE, NULL, 5);
INSERT INTO "Rule" ("Id", "CriteriaId", "Description", "IsScaleRule", "Type", "Value")
VALUES (28, 5, 'за каждый отсутствующий пункт из чеклиста по оформлению репозитория: https://github.com/yurii-litvinov/courses/blob/master/additional/repo-checklist/repo-checklist.pdf', FALSE, 'custom', -1);


INSERT INTO "Users" ("Id", "MeetingId", "PasswordHash", "RoleId", "UserName")
VALUES (1, NULL, '$2a$11$0CCsMkYMzLq/5/tvvlwb/OpAaYuXul1te/yuKAYm9unI5fehP5r82', 1, 'admin');


CREATE INDEX "IX_AverageCriteriaMark_StudentWorkId" ON "AverageCriteriaMark" ("StudentWorkId");


CREATE INDEX "IX_CriteriaMark_CriteriaId" ON "CriteriaMark" ("CriteriaId");


CREATE INDEX "IX_CriteriaMark_MemberMarkId" ON "CriteriaMark" ("MemberMarkId");


CREATE INDEX "IX_CriteriaMeeting_MeetingsId" ON "CriteriaMeeting" ("MeetingsId");


CREATE UNIQUE INDEX "IX_MemberMarks_MemberId_StudentWorkId" ON "MemberMarks" ("MemberId", "StudentWorkId");


CREATE INDEX "IX_MemberMarks_StudentWorkId" ON "MemberMarks" ("StudentWorkId");


CREATE INDEX "IX_Rule_CriteriaId" ON "Rule" ("CriteriaId");


CREATE INDEX "IX_SelectedRule_CriteriaMarkId" ON "SelectedRule" ("CriteriaMarkId");


CREATE INDEX "IX_StudentWork_MeetingId" ON "StudentWork" ("MeetingId");


CREATE INDEX "IX_Users_MeetingId" ON "Users" ("MeetingId");


CREATE INDEX "IX_Users_RoleId" ON "Users" ("RoleId");


SELECT setval(
               pg_get_serial_sequence('"Criteria"', 'Id'),
               GREATEST(
                       (SELECT MAX("Id") FROM "Criteria") + 1,
                       nextval(pg_get_serial_sequence('"Criteria"', 'Id'))),
               false);
SELECT setval(
               pg_get_serial_sequence('"Role"', 'Id'),
               GREATEST(
                       (SELECT MAX("Id") FROM "Role") + 1,
                       nextval(pg_get_serial_sequence('"Role"', 'Id'))),
               false);
SELECT setval(
               pg_get_serial_sequence('"Rule"', 'Id'),
               GREATEST(
                       (SELECT MAX("Id") FROM "Rule") + 1,
                       nextval(pg_get_serial_sequence('"Rule"', 'Id'))),
               false);
SELECT setval(
               pg_get_serial_sequence('"Users"', 'Id'),
               GREATEST(
                       (SELECT MAX("Id") FROM "Users") + 1,
                       nextval(pg_get_serial_sequence('"Users"', 'Id'))),
               false);